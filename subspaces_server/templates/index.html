<html>
	<head>
		<title>Plot Chameleon Data</title>

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/js/standalone/selectize.min.js" integrity="sha256-+C0A5Ilqmu4QcSPxrlGpaZxJ04VjsRjKu+G82kl5UJk=" crossorigin="anonymous"></script>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/css/selectize.bootstrap3.min.css" integrity="sha256-ze/OEYGcFbPRmvCnrSeKbRTtjG4vGLHXgOqsyLFTRjg=" crossorigin="anonymous" />

		<!-- Load Bootstrap, style.css & favicon-->
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" integrity="sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF" crossorigin="anonymous"></script>

		<link rel="icon" type="image/x-icon" href="static/images/favicon_musicolab.png">
		<link rel="stylesheet" href="/static/css/style.css">

		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">

		<!-- SweetAlert library -->
		<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

	
    	<script type="text/javascript" src="static/js/main.js"></script>
		<script src="https://unpkg.com/opensheetmusicdisplay@0.8.3/build/opensheetmusicdisplay.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/@magenta/music@1.23.1/dist/magentamusic.min.js"></script>

	</head>
	{% include 'sidenavigation.html' %}
	<body>
	<div class="main__container">
		<div class="secondary__container">
			<span class="main__info-icon" onclick="mainInfo()">&#9432;</span>
			
		  	<div class="infos__main-container">		        
				<div class="infos__highlight-song-selectors-container">
		            <div class="infos__highlight-song-select" style="width:240px;">
		                <select id="songname-selector" placeholder="Song to blend">
		                </select>
		            </div>
		            <div class="infos__highlight-song-select" style="width:240px;">
		                <select id="blending-characteristics-selector" placeholder="Blend with">
		                </select>
		            </div>
					<div class="buttons_container">
						<div class="submit_for_blending">
							<button id="sendButton">Blend it!</button>
						</div>
						<a id="download_button" href="/download/Rhythm_a_ning_blended_with_Fusion.xml" download="Rhythm_a_ning_blended_with_Fusion.xml">
							<button>Download File</button>
						</a>
					</div>
					
		        </div>
		  	</div>	
			<div class="response_container" id="response_container">

			</div>
			
	  	</div>
			
	</div>
	<div class="osmdContainer" id="osmdContainer">

	</div>
	<script>
		// var osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("osmdContainer");
		// 	osmd.setOptions({
		// 		backend: "svg",
		// 		drawTitle: true,
		// 		// drawingParameters: "compacttight" // don't display title, composer etc., smaller margins
		// 	});
		// 	osmd
		// 		.load("static/xml/altered_score.xml")
		// 		.then(
		// 		function() {
		// 			osmd.render();
		// 		}
		// 		)
	function applyNamesToSelect(response) {

		var namesforselect = [];
		namesforselect.push("None");
		for (i=0; i<response.length; i++) {
			namesforselect.push(response[i].replaceAll("_", " "));
		}
		var items = namesforselect.map(function(x) { return { item: x }; });

		$("#songname-selector").selectize({
			delimiter: ',',
			persist: false,
			create: false,
			options: items,
			searchField: ['item'],
			labelField: "item",
			valueField: "item",
		});
	}
	send_request_get_response( location.href + 'songsnameslist', applyNamesToSelect );


	function applyBlendingModesToSelect(response) {
		// Create an array of strings containing secondary values
		const secondaryValues = [];

		for (const key in response) {
		if (response.hasOwnProperty(key)) {
			const firstValue = response[key][0];
			response[key].forEach(secondaryValue => {
			secondaryValues.push(`${key}: ${secondaryValue}`);
			});
		}
		}

		// Print the array of secondary values
		console.log(secondaryValues);

		var namesforselect = [];
		namesforselect.push("None");
		for (i=0; i<secondaryValues.length; i++) {
			namesforselect.push(secondaryValues[i].replaceAll("_", " "));
		}
		var items = namesforselect.map(function(x) { return { item: x }; });

		$("#blending-characteristics-selector").selectize({
			delimiter: ',',
			persist: false,
			create: false,
			options: items,
			searchField: ['item'],
			labelField: "item",
			valueField: "item"
		});
	}
	send_request_get_response( location.href + 'stylesHMM', applyBlendingModesToSelect );
	function sendUserOption(userOption) {
		g = document.getElementById("songname-selector").value;
		console.log(g)

	}
	
	// document.getElementById("songname-selector").onchange = function () {

			
    //         // Get the string to send
    //         const dataToSend = document.getElementById("songname-selector").value; // Replace with the data you want to send

    //         // Send an HTTP POST request to the Flask server
    //         fetch('/receive-user-option', {
    //             method: 'POST',
    //             body: dataToSend
    //         })
    //         .then(response => response.text())
    //         .then(responseText => {
    //             alert(responseText); // Display the response from the server
    //         })
    //         .catch(error => {
    //             console.error('Error:', error);
    //         });
    //     };
	// document.getElementById("blending-characteristics-selector").onchange = function() {clusterTrace("second-song")};
	
	

	document.getElementById('sendButton').addEventListener('click', function () {

		

		var songnameValue = document.getElementById("songname-selector").value;
		var blendingCharacteristicsValue = document.getElementById("blending-characteristics-selector").value;
		const responseContainer = document.getElementById("response_container");
		console.log(songnameValue, blendingCharacteristicsValue);
		// Check if both dropdowns have "None" selected
		if (songnameValue === '' || songnameValue === 'None' || blendingCharacteristicsValue === '' || blendingCharacteristicsValue === 'None') {
			// Display a SweetAlert alert message
			Swal.fire({
				title: 'Selection Required',
				text: 'Please select both song name and blending characteristics.',
				icon: 'error',
				confirmButtonText: 'OK'
			});
		} else {
			// Get the string to send
			const jsonData = {
				song_name: songnameValue,
				blending_characteristic: blendingCharacteristicsValue
			};

			// Convert the JavaScript object to a JSON string
			const dataToSend = JSON.stringify(jsonData);
			// Send an HTTP POST request to the Flask server
			fetch('/receive-user-option', {
				method: 'POST',
				body: dataToSend
			})
			.then(response => response.text())
			.then(responseText => {


				

				// Get the element with the id "osmdContainer"
				var osmdContainer = document.getElementById("osmdContainer");

				// Clear the HTML content of the element
				osmdContainer.innerHTML = "";

				songnameValue = songnameValue.replace(/'/g, "_");
				songnameValue = songnameValue.replace(/-/g, "_");
				songnameValue = songnameValue.replace(/ /g, "_");
				blendingCharacteristicsValue = blendingCharacteristicsValue.replace("genre: ", "")
				blendingCharacteristicsValue = blendingCharacteristicsValue.replace("harmonic: ", "")
				songnameValue = songnameValue + "_blended_with_" + blendingCharacteristicsValue + ".xml";

				function changeDownloadAttributes(newFilename) {

					// Get the <a> element by its ID
					var downloadLink = document.getElementById('download_button');
					// Make the download link visible
    				downloadLink.style.display = 'inline';
					// Update the href and download attributes
					downloadLink.href = "/download/" + newFilename;
					downloadLink.download = newFilename;
				}
				newFilename = songnameValue;
				changeDownloadAttributes(newFilename);

				console.log(songnameValue);
				console.log(blendingCharacteristicsValue);
				
				var osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("osmdContainer");
				osmd.setOptions({
					backend: "svg",
					drawTitle: true,
				});
				osmd
					.load("static/xml/" + songnameValue)
					.then(
					function() {
						osmd.render();
					}
					)
				// // Split the input string into rows based on "||"
				// const rows = responseText.split("||");

				// // Create a table element
				// const table = document.createElement("table");

				// // Iterate through rows
				// rows.forEach((rowText) => {
				// // Split the row into cells based on "|"
				// const cells = rowText.split("|");

				// // Create a new row for each row in the table
				// const row = document.createElement("tr");

				// // Iterate through cells and create cell elements
				// cells.forEach((cellText) => {
				// 	// Create a new cell for each cell in the row
				// 	const cell = document.createElement("td");
				// 	cell.textContent = cellText.trim(); // Trim any leading/trailing spaces
				// 	row.appendChild(cell);
				// });

				// // Add the row to the table
				// table.appendChild(row);
				// });

				// // Append the table to your document (e.g., a specific HTML element with an id)
				// document.getElementById("response_container").appendChild(table);
				// alert(responseText); // Display the response from the server
			})
			.catch(error => {
				console.error('Error:', error);
			});
		}
		
    });

	// Main Info message

	function mainInfo() {
		Swal.fire({
				icon: 'info',
				html:'<p class="swal__paragraph"><span></span>The UI allows you to blend a song with a harmonic subspace of a jazz idiom. </p><p class="swal__paragraph">After selecting a piece and an idiom click "Blend it!" and the resulting score will appear beneath. The Chord Symbols above the melody are the original ones and the Chord Symbols below the melody are the generated ones</p><p class="swal__paragraph">All your blends are being saved and you can access them from the menu bar</p>',
				width: '20rem'
			});
	}
	</script>

</body>
</html>
